---
title: "Homework Assignment #2"
subtitle: "Exploring patterns of environmental justice"
author: "Jordan Sibley"
date: last-modified
execute: 
  eval: true
  message: false
  warning: false
format:
  html:
    toc: true
editor_options: 
---


## Set up

### Load Packages 
```{r}
#| code-fold: true
#| code-summary: "Show the code"

# load libraries 
library(tidyverse)
library(here)
library(tmap)
library(dplyr)
library(sf)
library(kableExtra)

```


### Read in Data
```{r}
#| output: false
#| quiet: true
#| code-fold: true
#| code-summary: "Show the code"

# read in data 

la_holc <- sf::st_read(here::here("data", "mapping-inequality", "mapping-inequality-los-angeles.json"))

la_birds <- sf::st_read(here::here("data", "gbif-birds-LA", "gbif-birds-LA.shp"))

ejscreen <- sf::st_read(here::here("data","ejscreen","EJSCREEN_2023_BG_StatePct_with_AS_CNMI_GU_VI.gdb")) 
```


## Cleaning Data

#### Filtering EJScreen Data
```{r}
#| code-fold: true
#| code-summary: "Show the code"

# filtering ejscreen to only include counties that make up the greater LA area 
la_ej <- ejscreen %>% 
  dplyr::filter(STATE_NAME == "California") %>% 
  dplyr::filter(CNTY_NAME %in% c("Los Angeles County", "San Bernardino County", "Orange County")) %>% 
  dplyr::filter((ID != '060379902000') & (ID != '060379903000')) # remove blocks in are in the ocean
```

#### Removing NA value from HOLC Grade data 
```{r}
#| code-fold: true
#| code-summary: "Show the code"

# removing NA values in the 'grade' column of la_holc
la_holc <- la_holc %>% 
  filter(!is.na(grade)) # remove the 1 NA value
```

## Exploring the Data

#### Looking at the class

```{r}
class(la_holc) 

class(la_ej)
```

Both data sets are sf data frames.

#### Determining the Coordinate Reference Systems

```{r}
# check that the coordinate reference systems match 
if(st_crs(la_holc) == st_crs(la_ej)) {
  print("The coordinate reference systems match")
} else {
  print("The coordinate reference systems do NOT match. Transformation of CRS is recommended.")
}
```

The CRS of `la_holc` and `la_ej` are not the same. In order to use these two data sets in the same map, the CRS of one needs to be transformed to match the other

```{r}
# ensures the CRS of the two datasets will match 
la_holc = st_transform(la_holc, crs = st_crs(la_ej))

# check to see if CRS match
if(st_crs(la_holc) == st_crs(la_ej)) {
  print("The coordinate reference systems now match")
} else {
  warning("The coordinate reference systems still do NOT match. Check that you did the transformation correctly")
}
```

Now the CRS of each data set is matched. 

## Part 1: Legacy of redlining in current environmental (in)justice

Your first task is to explore historical redlining in Los Angeles and its legacy on present-day environmental justice.

#### Map of historical Los Angeles redlining neighborhoods


```{r}
#| code-fold: true
#| code-summary: "Show the code"

# map of la county with the holc grades 
tmap_mode('plot')
bbox_la <- st_bbox(la_holc) # bounding box to area of county with holc grades 


tm_shape(la_ej, bbox = bbox_la) +
  tm_polygons(col = "#EFDECD") + # county background color 
tm_shape(la_ej) +
  tm_borders(col = "#D6BA98") + # block border colors 
tm_shape(la_holc) +
  tm_polygons("grade", # la map colored by grade 
              palette = c("#76a865", "#7cb5bd", "#ffff00", "#d9838d"),
              title = "HOLC Grade") +
  tm_credits("Pacific Ocean", 
             position = c(0.02, 0.3), size = 0.6) + # pacific ocean label 
   
  tm_scale_bar(position = c(0.02, 0.02), width = 0.1) + # scale bar
  tm_compass(position = c(0.01, 0.08), text.size = 0.5)+ # compass
  tm_layout(bg.color = "#D7F7FD", # blue background color 
            legend.outside = TRUE,
            fontfamily = "serif",
            main.title = "Los Angeles County Historic Redlining Neighborhoods",
            )
   

```

**Map Description** Home Ownersâ€™ Loan Corporation (HOLC) neighborhood rating system from the 1930's. Grades were determined based on their perceived safety for real estate investment. The ranking system is as follows: A "Best", B "Still desirable", C "Declining", D "Hazardous". 



#### Percent of current census block groups within each HOLC grade 

In order to find the current census block groups within each HOLC grade, I need to use a topological operator to see which census groups ('ID') intersect with the HOLC neighborhood geometries. 

There are many different ways to find this relationship, but I choose to use `st_intersection`. A caveat of this operator is that there is potential for double counting of census blocks if there are more than one HOLC neighbor within the block. 


```{r}
#| code-fold: true
#| code-summary: "Show the code"

# filter EJScreen to just Los Angeles county 
la_county <- ejscreen %>% 
  dplyr::filter(CNTY_NAME == "Los Angeles County")

# join data sets to find overlapping geometries (interjoin will include NA values)
holc_census <- st_join(x = la_county, y = la_holc, join = st_intersects, left = TRUE) %>%
  group_by(grade) %>% 
  summarise(count_blocks = n(), # count of blocks in each HOLC grade 
            percentage = (n() / nrow(la_ej)) * 100) %>% # % of census blocks 
  st_drop_geometry() # dropping geometry for the table 
 
  
# putting the info in a table
kable(holc_census, 
      col.names = c("HOLC grade",
                        "Count of census blocks",
                        "% of blocks within grade "),
      caption = "Percentage of Census Block Groups per HOLC Grade") %>% 
  kable_styling(bootstrap_options = "striped", full_width = FALSE, position = "center")

```

The NA value corresponds to the census block groups that do not intersect or touch any of the historic HOLC graded neighborhoods. 


3.  a set of figures summarizing current conditions (from the EJScreen data) within HOLC grades using the mean of the following variables:


#### Percentage of low income households within the HOLC grades 

```{r}
#| code-fold: true
#| code-summary: "Show the code"

# filter la_county to only include 'Shape', 'ID' and 'LOWINCPCT'
la_lowincome <- la_county %>% 
  select('Shape', 'ID', 'LOWINCPCT')

# spatial join low income and HOLC grade 
holc_lowincome <- st_join(x = la_holc, y = la_lowincome, join = st_intersects, left = TRUE) %>% 
  group_by(grade) %>%
  summarise(
    avg_pct_lowincome = (mean(LOWINCPCT, na.rm = TRUE) * 100),  # mean percent of low-income households
    count_blocks = n() ) %>%  # number of census blocks per HOLC grade
  st_drop_geometry()

# bar graph to display results 
ggplot(data = holc_lowincome, aes(x = grade, y = avg_pct_lowincome, fill = grade)) +
  geom_col() +
  scale_fill_manual(values = c("A" = "#76a865", "B" = "#7cb5bd", "C" = "#ffff00", "D" = "#d9838d")) +# bar colors
  labs(x = 'HOLC Grade',
       y = 'Average % of low income households',
       title = 'Percentage of low income households within Los Angeles HOLC neighborhoods (2021)') + 
  theme_classic() +
  theme(legend.position = "none")
```

It is also important to recognize that the Environmental Justice Screen was collected using 2021 census data.  

#### Percentile of air quality (Particulate Matter 2.5) within HOLC grade neighborhoods

```{r}
# filter la_county to only include 'Shape', 'ID' and 'P_D2_PM25'
la_air_quality <- la_county %>% 
  select('Shape', 'ID', 'P_D2_PM25')
```


#### Percentile of low-life expentancy within HOLC grade neighborhoods

```{r}

```


4.  brief paragraph reflecting on these results

## Part 2: Legacy of redlining in biodiversity observations

Your second task is to explore the legacy of historical redlining in Los Angeles on the collection of bird observations.

#### Description

For this assignment, you must produce the following based on observations from 2022:

1.  a figure summarizing the percent of observations within redlined neighborhoods within each HOLC grade
2.  a brief paragraph explaining whether these results match the findings from Ellis-Soto et al. 2023


NOTES FROM SLACK 
part2 asks you to summarize the % of observations within each redlining grade. it's up to you whether or not you also include the % outside of the redlined districts

NOTES FROM JOSH 
pct_bird_obs_area <- joined_birds %>%
  filter(year == 2022, (grade != "NA")) %>%
  group_by(grade) %>% 
  summarise(
    total_area = sum(area, na.rm = TRUE),
    grade_count = n()) %>%
  mutate(bird_count_area = grade_count/total_area) %>%
  select(grade, bird_count_area) %>% 
  st_drop_geometry() 