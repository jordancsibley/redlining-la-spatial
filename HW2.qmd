---
title: "Homework Assignment #2"
subtitle: "Exploring patterns of environmental justice"
author: "Jordan Sibley"
date: last-modified
execute: 
  eval: true
  message: false
  warning: false
format:
  html:
    toc: true
editor_options: 
---


## Set up

### Load Packages 
```{r}
#| code-fold: true
#| code-summary: "Show the code"

# load libraries 
library(tidyverse)
library(here)
library(tmap)
library(dplyr)
library(sf)
library(kableExtra)
library(patchwork)

```


### Read in Data
```{r}
#| output: false
#| quiet: true
#| code-fold: true
#| code-summary: "Show the code"

# read in data 

la_holc <- sf::st_read(here::here("data", "mapping-inequality", "mapping-inequality-los-angeles.json"))

la_birds <- sf::st_read(here::here("data", "gbif-birds-LA", "gbif-birds-LA.shp"))

ejscreen <- sf::st_read(here::here("data","ejscreen","EJSCREEN_2023_BG_StatePct_with_AS_CNMI_GU_VI.gdb")) 
```


## Cleaning Data

#### Filtering EJScreen Data
```{r}
#| code-fold: true
#| code-summary: "Show the code"

# filtering ejscreen to only include counties that make up the greater LA area 
la_ej <- ejscreen %>% 
  dplyr::filter(STATE_NAME == "California") %>% 
  dplyr::filter(CNTY_NAME %in% c("Los Angeles County", "San Bernardino County", "Orange County")) %>% 
  dplyr::filter((ID != '060379902000') & (ID != '060379903000')) # remove blocks in are in the ocean
```

#### Removing NA value from HOLC Grade data 
```{r}
#| code-fold: true
#| code-summary: "Show the code"

# removing NA values in the 'grade' column of la_holc
la_holc <- la_holc %>% 
  filter(!is.na(grade)) # remove the 1 NA value
```

## Exploring the Data

#### Looking at the class

```{r}
class(la_holc) 

class(la_ej)
```

Both data sets are sf data frames.

#### Determining the Coordinate Reference Systems

```{r}
# check that the coordinate reference systems match 
if(st_crs(la_holc) == st_crs(la_ej)) {
  print("The coordinate reference systems match")
} else {
  print("The coordinate reference systems do NOT match. Transformation of CRS is recommended.")
}
```

The CRS of `la_holc` and `la_ej` are not the same. In order to use these two data sets in the same map, the CRS of one needs to be transformed to match the other

```{r}
# ensures the CRS of the two datasets will match 
la_holc = st_transform(la_holc, crs = st_crs(la_ej))

# check to see if CRS match
if(st_crs(la_holc) == st_crs(la_ej)) {
  print("The coordinate reference systems now match")
} else {
  warning("The coordinate reference systems still do NOT match. Check that you did the transformation correctly")
}
```

Now the CRS of each data set is matched. 

# Part 1: Legacy of redlining in current environmental (in)justice

Exploring historical redlining in Los Angeles and its legacy on present-day environmental justice.

### Map of historical Los Angeles redlining neighborhoods


```{r}
#| code-fold: true
#| code-summary: "Show the code"

# map of la county with the holc grades 
tmap_mode('plot')
bbox_la <- st_bbox(la_holc) # bounding box to area of county with holc grades 


tm_shape(la_ej, bbox = bbox_la) +
  tm_polygons(col = "#EFDECD") + # county background color 
tm_shape(la_ej) +
  tm_borders(col = "#D6BA98") + # block border colors 
tm_shape(la_holc) +
  tm_polygons("grade", # la map colored by grade 
              palette = c("#76a865", "#7cb5bd", "#ffff00", "#d9838d"),
              title = "HOLC Grade") +
  tm_credits("Pacific Ocean", 
             position = c(0.02, 0.3), size = 0.6) + # pacific ocean label 
   
  tm_scale_bar(position = c(0.02, 0.02), width = 0.1) + # scale bar
  tm_compass(position = c(0.01, 0.08), text.size = 0.5)+ # compass
  tm_layout(bg.color = "#D7F7FD", # blue background color 
            legend.outside = TRUE,
            fontfamily = "serif",
            main.title = "Los Angeles County Historic Redlining Neighborhoods",
            )
   

```

**Map Description** Home Owners’ Loan Corporation (HOLC) neighborhood rating system from the 1930's. Grades were determined based on their perceived safety for real estate investment. The ranking system is as follows: A "Best", B "Still desirable", C "Declining", D "Hazardous". 



### Percent of current census block groups within each HOLC grade 

In order to find the current census block groups within each HOLC grade, I need to use a topological operator to see which census groups ('ID') intersect with the HOLC neighborhood geometries. 

There are many different ways to find this relationship, but I choose to use `st_intersection`. A caveat of this operator is that there is potential for double counting of census blocks if there are more than one HOLC neighbor within the block. 


```{r}
#| code-fold: true
#| code-summary: "Show the code"

# filter EJScreen to just Los Angeles county 
la_county <- ejscreen %>% 
  dplyr::filter(CNTY_NAME == "Los Angeles County")

# join data sets to find overlapping geometries (interjoin will include NA values)
holc_census <- st_join(x = la_county, y = la_holc, join = st_intersects, left = TRUE) %>%
  group_by(grade) %>% 
  summarise(count_blocks = n(), # count of blocks in each HOLC grade 
            percentage = (n() / nrow(la_county)) * 100) %>% # % of census blocks 
  st_drop_geometry() # dropping geometry for the table 
 
  
# putting the info in a table
kable(holc_census, 
      col.names = c("HOLC grade",
                        "Count of census blocks",
                        "% of blocks within grade "),
      caption = "Percentage of Census Block Groups per HOLC Grade") %>% 
  kable_styling(bootstrap_options = "striped", full_width = FALSE, position = "center")

```

The NA value corresponds to the census block groups that do not intersect or touch any of the historic HOLC graded neighborhoods. 


## Current Conditions within the HOLC Grades

#### Spatial Join of HOLC data and EJ Screen Data
```{r}
#| code-fold: true
#| code-summary: "Show the code"

# join holc and ej data, summarise low income, air quality, and low life expectancy 
holc_ej_join <- st_join(x = la_holc, y = la_county, join = st_intersects, left = TRUE) %>% 
  group_by(grade) %>%
  summarise(count_blocks = n(),
            avg_pct_lowincome = mean(LOWINCPCT)*100,
            avg_pct_pm = mean(P_D2_PM25),
            avg_pct_lowlife = mean(P_LIFEEXPPCT, na.rm = TRUE)) %>% 
  st_drop_geometry()
```

#### Plot of the mean percent low-income neighborhoods. 
```{r}
#| code-fold: true
#| code-summary: "Show the code"

# bar graph to display results 
ggplot(data = holc_ej_join, aes(x = grade, y = avg_pct_lowincome, fill = grade)) +
  geom_col() +
  scale_fill_manual(values = c("A" = "#76a865", "B" = "#7cb5bd", "C" = "#ffff00", "D" = "#d9838d")) +# bar colors
  labs(x = 'HOLC Grade',
       y = 'Average % of low income households',
       title = 'Mean Percentage of low income households \n within Los Angeles HOLC neighborhoods (2021)') + 
  theme_classic() +
  theme(legend.position = "none")
```

#### Percentile of air quality (Particulate Matter 2.5) within HOLC grade neighborhoods
```{r}
#| code-fold: true
#| code-summary: "Show the code"

# bar graph to display results 
ggplot(data = holc_ej_join, aes(x = grade, y = avg_pct_pm, fill = grade)) +
  geom_col() +
  scale_fill_manual(values = c("A" = "#76a865", "B" = "#7cb5bd", "C" = "#ffff00", "D" = "#d9838d")) +# bar colors
  labs(x = 'HOLC Grade',
       y = 'Average Percentile for Particulate Matter 2.5',
       title = 'Mean Percentile for Particulate Matter 2.5 \n within Los Angeles HOLC neighborhoods (2021)') + 
  theme_classic() +
  theme(legend.position = "none")
```

#### Percentile of low-life expentancy within HOLC grade neighborhoods
```{r}
#| code-fold: true
#| code-summary: "Show the code"

# bar graph to display results 
ggplot(data = holc_ej_join, aes(x = grade, y = avg_pct_lowlife, fill = grade)) +
  geom_col() +
  scale_fill_manual(values = c("A" = "#76a865", "B" = "#7cb5bd", "C" = "#ffff00", "D" = "#d9838d")) +# bar colors
  labs(x = 'HOLC Grade',
       y = 'Average Percentile for Low Life Expectancy',
       title = 'Mean Percentile for Low Life Expectancy \n within Los Angeles HOLC neighborhoods(2021)') + 
  theme_classic() +
  theme(legend.position = "none")
```
It is also important to recognize that the Environmental Justice Screen was collected using 2021 census data.  


In addition to viewing the average values of the EJ Screen parameters, I beleive it is important to also examine the spread of densities 

#### Density plots for Percentile PM 2.5 and low life expencty within HOLC grade neighborhoods

In addition to viewing the average values of the EJ Screen parameters, I believe it is important to also examine the spread of densities. 
```{r}
#| code-fold: true
#| code-summary: "Show the code"

# filter la_county to only include 'Shape', 'ID' and 'P_D2_PM25'
la_air_quality <- la_county %>% 
  select('Shape', 'ID', 'P_D2_PM25')

# join PM data with HOLC data 
holc_pm <- st_join(x = la_holc, y = la_air_quality, join = st_intersects, left = TRUE) 

# violin plot to show densities 
fig1<- ggplot(holc_pm, aes(x = grade, y = P_D2_PM25, fill = grade)) +
  geom_violin() +
  scale_fill_manual(values = c("A" = "#76a865", "B" = "#7cb5bd", "C" = "#ffff00", "D" = "#d9838d")) + # bar colors
  geom_boxplot(width=0.1) + # box plot to show interquartile range 
  labs(x = "HOLC Grade",
       y = "Percentile for Particulate Matter 2.5",
       title = "Air Quality within \nLos Angeles HOLC neighborhoods (2021)") +
  theme_classic() +
  theme(legend.position = "none",
        panel.grid.major.y = element_line(color = "darkgrey",
                                          size = 0.25,
                                          linetype = 1))

# filter la_county to only include 'Shape', 'ID' and 'P_LIFEEXPPCT'
la_low_life <- la_county %>% 
  select('Shape', 'ID', 'P_LIFEEXPPCT')

# join PM data with HOLC data 
holc_low_life <- st_join(x = la_holc, y = la_low_life, join = st_intersects, left = TRUE) 

# violin plot to show denisties
fig2<- ggplot(holc_low_life, aes(x = grade, y = P_LIFEEXPPCT, fill = grade)) +
  geom_violin() +
  scale_fill_manual(values = c("A" = "#76a865", "B" = "#7cb5bd", "C" = "#ffff00", "D" = "#d9838d")) + # bar colors
  geom_boxplot(width=0.1) + # box plot to show interquartile range 
  labs(x = "HOLC Grade",
       y = "Percentile for Low Life Expectancy",
       title = "Low Life Expentancy Percentiles \nwithin Los Angeles HOLC neighborhoods (2021) ") +
  theme_classic() +
  theme(legend.position = "none",
        panel.grid.major.y = element_line(color = "darkgrey",
                                          size = 0.25,
                                          linetype = 1))

(fig1 | fig2)
```

From EJ Screen Documentation: 

The PM 2.5 indicator is a measure of potential exposure to inhalable particles that are 2.5 micrometers or smaller. This is measured in terms of annual average concentration in air measured in micrograms per cubic meter. PM 2.5 information included in EJScreen highlights areas across the U.S. that have the highest PM 2.5 levels when compared to the nation or state. It does not indicate

From EJ Screen Documentation: 

Low Life Expectancy—To highlight areas where the life expectancy is lower than National norms, EJScreen uses an inverse measure showing higher values for lower years and lower scores for higher years. Low Life Expectancy is an inverse of the normalized life expectancy (as defined below) derived from the Life Expectancy at Birth from Centers for Disease Control and Prevention (CDC), National Center for Health Statistics (NCHS): % Low Life Expectancy is defined as “1 – (Life Expectancy / Max Life Expectancy)”

4.  brief paragraph reflecting on these results

TEXT HERE 

# Part 2: Legacy of redlining in biodiversity observations

Your second task is to explore the legacy of historical redlining in Los Angeles on the collection of bird observations.

#### Description

For this assignment, you must produce the following based on observations from 2022:

1.  a figure summarizing the percent of observations within redlined neighborhoods within each HOLC grade
2.  a brief paragraph explaining whether these results match the findings from Ellis-Soto et al. 2023

  
  
First, we need to see if the bird observations and the HOLC grade neighborhood data is operating under the same coordinate reference system. 

```{r}
# check if data has same crs 
if(st_crs(la_holc) == st_crs(la_birds)) {
  print("The coordinate reference systems match")
} else {
  print("The coordinate reference systems do NOT match. Transformation of CRS is recommended.")
}
```

Now the CRS of `la_birds` can be transformed to match `la_holc`
```{r}
# ensures the CRS of the two datasets will match 
la_birds = st_transform(la_birds, crs = st_crs(la_holc))

# check to see if CRS match
if(st_crs(la_holc) == st_crs(la_birds)) {
  print("The coordinate reference systems now match")
} else {
  warning("The coordinate reference systems still do NOT match. Check that you did the transformation correctly")
}
```

  
Need to join bird observations to HOLC grade data 
Then, figure out how many observations are per HOLC grade per area to account for the amount of land each holc grade occupies. 

NEED TO FIGURE OUT THE UNITS OF AREA 

maybe could produce two bar graphs, one with total area per holc grade, and then another of number of observations per holc grade area. 

a figure summarizing the **percent** of observations within redlined neighborhoods within each HOLC grade
```{r}
holc_la_birds <-st_join(x = la_holc, y = la_birds, join = st_intersects, left = FALSE) %>% 
  filter(year == 2022) %>%
  group_by(grade) %>% 
  summarise(grade_area_total = sum(area, na.rm = TRUE),
            obs_count = n()) %>%
  mutate(obs_per_area = obs_count/grade_area_total) %>%
  st_drop_geometry() 
```


